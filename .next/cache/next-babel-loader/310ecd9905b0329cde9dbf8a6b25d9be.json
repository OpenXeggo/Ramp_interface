{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useReducer, useState, useEffect } from \"react\";\nimport { useWeb3React } from \"@web3-react/core\";\nimport { parseEther } from \"@ethersproject/units\";\nimport { formatEther } from \"@ethersproject/units\";\nimport Account from \"./Account\";\nimport useContract from \"../hooks/useContract\";\nimport useEtherContract from \"../hooks/useEtherContract\";\nimport useEagerConnect from \"../hooks/useEagerConnect\";\nimport { constants, formatEtherscanLink } from \"../util\";\nimport { EscrowFactory } from \"../abi/EscrowFactory\";\nimport EscrowContractFactory from \"../abi/EscrowContractFactory.json\";\nvar defaultFormData = {\n  paymentid: \"\",\n  amount: \"\"\n};\n\nvar formReducer = function formReducer(state, event) {\n  if (event.reset) {\n    return defaultFormData;\n  }\n\n  return _objectSpread(_objectSpread({}, state), {}, _defineProperty({}, event.name, event.value));\n};\n\nexport default function Sell() {\n  var _useReducer = useReducer(formReducer, defaultFormData),\n      formData = _useReducer[0],\n      setFormData = _useReducer[1];\n\n  var _useState = useState(false),\n      submitting = _useState[0],\n      setSubmitting = _useState[1];\n\n  var _useState2 = useState(false),\n      reverted = _useState2[0],\n      setReverted = _useState2[1];\n\n  var _useState3 = useState([]),\n      escrows = _useState3[0],\n      setEscrows = _useState3[1];\n\n  var _useState4 = useState(\"\"),\n      selected = _useState4[0],\n      setSelected = _useState4[1];\n\n  var _useState5 = useState(\"...\"),\n      balance = _useState5[0],\n      setBalance = _useState5[1];\n\n  var _useWeb3React = useWeb3React(),\n      library = _useWeb3React.library,\n      account = _useWeb3React.account,\n      active = _useWeb3React.active,\n      error = _useWeb3React.error,\n      chainId = _useWeb3React.chainId;\n\n  var isConnected = typeof account === \"string\" && !!library;\n  var triedToEagerConnect = useEagerConnect();\n  var EscrowInstance = useEtherContract(EscrowFactory);\n  var escrowFactory = useContract(constants.ESCROW_FACTORY_ADDRESS, EscrowContractFactory, true);\n\n  var handleSubmit = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(event) {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              event.preventDefault();\n              setSubmitting(true);\n              setReverted(false);\n              _context.next = 5;\n              return escrowFactory.newEscrow(formData.paymentid, {\n                value: parseEther(formData.amount)\n              }).then(function (res) {\n                setFormData({\n                  reset: true\n                });\n              })[\"catch\"](function (e) {\n                if (e.code == -32016) setReverted(true);\n                console.error(e);\n              })[\"finally\"](function () {\n                return setSubmitting(false);\n              });\n\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function handleSubmit(_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  var fetchEscrows = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var data;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return escrowFactory.getEscrows(account);\n\n            case 2:\n              data = _context2.sent;\n              setEscrows(data);\n              setSelected(data[0]);\n\n            case 5:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function fetchEscrows() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var getBalance = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var escrow, bal;\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              if (selected) {\n                _context3.next = 2;\n                break;\n              }\n\n              return _context3.abrupt(\"return\");\n\n            case 2:\n              if (EscrowInstance) {\n                _context3.next = 4;\n                break;\n              }\n\n              return _context3.abrupt(\"return\");\n\n            case 4:\n              _context3.next = 6;\n              return EscrowInstance.attach(selected);\n\n            case 6:\n              escrow = _context3.sent;\n              _context3.next = 9;\n              return escrow.getUnlockedBalance();\n\n            case 9:\n              bal = _context3.sent;\n              setBalance(formatEther(bal));\n\n            case 11:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    }));\n\n    return function getBalance() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var withdraw = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      var escrow, bal;\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              if (selected) {\n                _context4.next = 2;\n                break;\n              }\n\n              return _context4.abrupt(\"return\");\n\n            case 2:\n              _context4.next = 4;\n              return EscrowInstance.attach(selected);\n\n            case 4:\n              escrow = _context4.sent;\n              _context4.next = 7;\n              return escrow.getUnlockedBalance();\n\n            case 7:\n              bal = _context4.sent;\n              _context4.next = 10;\n              return escrow.withdraw(bal, account);\n\n            case 10:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n\n    return function withdraw() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  var deposit = /*#__PURE__*/function () {\n    var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              if (selected) {\n                _context5.next = 2;\n                break;\n              }\n\n              return _context5.abrupt(\"return\");\n\n            case 2:\n              _context5.next = 4;\n              return library.getSigner(account).sendTransaction({\n                to: selected,\n                value: parseEther(\"0.1\")\n              });\n\n            case 4:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    }));\n\n    return function deposit() {\n      return _ref5.apply(this, arguments);\n    };\n  }();\n\n  var handleChange = function handleChange(event) {\n    setFormData({\n      name: event.target.name,\n      value: event.target.value\n    });\n  };\n\n  var handleSelect = /*#__PURE__*/function () {\n    var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(event) {\n      return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              setSelected(event.target.value);\n\n            case 1:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6);\n    }));\n\n    return function handleSelect(_x2) {\n      return _ref6.apply(this, arguments);\n    };\n  }();\n\n  useEffect(function () {\n    if (isConnected) {\n      fetchEscrows();\n    }\n  }, [isConnected]);\n  useEffect(function () {\n    getBalance();\n  }, [selected]);\n  var escrowsList = escrows.length > 0 && escrows.map(function (item, i) {\n    return __jsx(\"option\", {\n      key: i,\n      value: item\n    }, item);\n  }, this);\n  return __jsx(\"div\", {\n    className: \"bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4\"\n  }, __jsx(\"div\", {\n    className: \"mb-4\"\n  }, __jsx(\"label\", {\n    className: \"block text-gray-700 text-xs mb-2\"\n  }, \"Deployed Escrows\"), __jsx(\"div\", {\n    className: \"flex\"\n  }, __jsx(\"div\", {\n    className: \"relative w-full\"\n  }, __jsx(\"select\", {\n    className: \"block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline\",\n    onChange: handleSelect,\n    value: selected\n  }, escrowsList), __jsx(\"div\", {\n    className: \"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700\"\n  }, __jsx(\"svg\", {\n    className: \"fill-current h-4 w-4\",\n    xmlns: \"http://www.w3.org/2000/svg\",\n    viewBox: \"0 0 20 20\"\n  }, __jsx(\"path\", {\n    d: \"M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z\"\n  })))), __jsx(\"a\", {\n    href: formatEtherscanLink(\"Account\", [chainId, selected]),\n    target: \"_blank\",\n    className: \"py-2 px-1\"\n  }, __jsx(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    className: \"h-5 w-5\",\n    fill: \"none\",\n    viewBox: \"0 0 24 24\",\n    stroke: \"currentColor\"\n  }, __jsx(\"path\", {\n    strokeLinecap: \"round\",\n    strokeLinejoin: \"round\",\n    strokeWidth: \"2\",\n    d: \"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14\"\n  })))), __jsx(\"div\", {\n    className: \"text-sm my-2\"\n  }, \"Balance: \", balance, \" ETH\"), __jsx(\"div\", {\n    className: \"flex pt-1\"\n  }, __jsx(\"button\", {\n    onClick: withdraw,\n    className: \"btn-blue m-auto p-2 text-sm\"\n  }, \"Withdraw\"), __jsx(\"button\", {\n    onClick: deposit,\n    className: \"btn-blue m-auto p-2 text-sm\"\n  }, \"Deposit\"))), __jsx(\"hr\", null), __jsx(\"br\", null), __jsx(\"form\", {\n    onSubmit: handleSubmit\n  }, __jsx(\"div\", {\n    className: \"mb-4\"\n  }, __jsx(\"label\", {\n    className: \"block text-gray-700 text-xs mb-2\"\n  }, \"Receive Payments at ID\"), __jsx(\"input\", {\n    className: \"appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:border-purple-500\",\n    name: \"paymentid\",\n    disabled: submitting,\n    type: \"text\",\n    minLength: 1,\n    maxLength: 79,\n    placeholder: \"name@upi\",\n    onChange: handleChange,\n    value: formData.paymentid\n  })), __jsx(\"div\", {\n    className: \"mb-4\"\n  }, __jsx(\"label\", {\n    className: \"block text-gray-700 text-xs mb-2\"\n  }, \"Amount to Sell\"), __jsx(\"input\", {\n    className: \"w-auto appearance-none border-2 border-gray-200 rounded py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:border-purple-500\",\n    name: \"amount\",\n    disabled: submitting,\n    inputMode: \"decimal\",\n    type: \"text\",\n    pattern: \"^[0-9]*[.,]?[0-9]*$\",\n    autoComplete: \"off\",\n    autoCorrect: \"off\",\n    minLength: 1,\n    maxLength: 79,\n    spellCheck: \"false\",\n    placeholder: \"0.0\",\n    onChange: handleChange,\n    value: formData.amount\n  }), __jsx(\"div\", {\n    className: \"w-auto inline-block p-2\"\n  }, \"ETH\")), reverted && __jsx(\"div\", {\n    className: \"w-full flex pt-4\"\n  }, \"Not enough funds in escrow...\"), __jsx(\"div\", {\n    className: \"w-full flex pt-4\"\n  }, isConnected ? __jsx(\"button\", {\n    type: \"submit\",\n    disabled: submitting,\n    className: \"btn-blue m-auto\"\n  }, \"Create Escrow\") : __jsx(\"div\", {\n    className: \"m-auto\"\n  }, __jsx(Account, {\n    triedToEagerConnect: triedToEagerConnect\n  })))));\n}","map":null,"metadata":{},"sourceType":"module"}