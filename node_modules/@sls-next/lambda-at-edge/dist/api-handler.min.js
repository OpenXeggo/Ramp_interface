"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./manifest.json"),t=require("./routes-manifest.json"),r=require("stream"),n=require("zlib"),o=require("http");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=i(e),s=i(t),u=i(r),f=i(n),d=i(o);const c={"accept-encoding":!0,"content-length":!0,"if-modified-since":!0,"if-none-match":!0,"if-range":!0,"if-unmodified-since":!0,"transfer-encoding":!0,via:!0},l={202:"Accepted",502:"Bad Gateway",400:"Bad Request",409:"Conflict",100:"Continue",201:"Created",417:"Expectation Failed",424:"Failed Dependency",403:"Forbidden",504:"Gateway Timeout",410:"Gone",505:"HTTP Version Not Supported",418:"I'm a teapot",419:"Insufficient Space on Resource",507:"Insufficient Storage",500:"Server Error",411:"Length Required",423:"Locked",420:"Method Failure",405:"Method Not Allowed",301:"Moved Permanently",302:"Moved Temporarily",207:"Multi-Status",300:"Multiple Choices",511:"Network Authentication Required",204:"No Content",203:"Non Authoritative Information",406:"Not Acceptable",404:"Not Found",501:"Not Implemented",304:"Not Modified",200:"OK",206:"Partial Content",402:"Payment Required",308:"Permanent Redirect",412:"Precondition Failed",428:"Precondition Required",102:"Processing",407:"Proxy Authentication Required",431:"Request Header Fields Too Large",408:"Request Timeout",413:"Request Entity Too Large",414:"Request-URI Too Long",416:"Requested Range Not Satisfiable",205:"Reset Content",303:"See Other",503:"Service Unavailable",101:"Switching Protocols",307:"Temporary Redirect",429:"Too Many Requests",401:"Unauthorized",422:"Unprocessable Entity",415:"Unsupported Media Type",305:"Use Proxy"},p={enableHTTPCompression:!1},h=(e,{enableHTTPCompression:t}=p)=>{const{request:r,response:n={headers:{}}}=e,o={headers:{}},i=new u.default.Readable,a=Object.assign(i,d.default.IncomingMessage.prototype);a.url=r.uri,a.method=r.method,a.rawHeaders=[],a.headers={},a.connection={},r.querystring&&(a.url=a.url+"?"+r.querystring);const s=r.headers||{};for(const e of Object.keys(s)){const t=s[e];t.forEach((e=>{a.rawHeaders.push(e.key),a.rawHeaders.push(e.value)})),a.headers[e]=t[0].value}a.getHeader=e=>a.headers[e.toLowerCase()],a.getHeaders=()=>a.headers,r.body&&r.body.data&&a.push(r.body.data,r.body.encoding?"base64":void 0),a.push(null);const h=new u.default;h.finished=!1,Object.defineProperty(h,"statusCode",{get:()=>o.status,set(e){o.status=e,o.statusDescription=l[e]}}),h.headers={},h.writeHead=(e,t)=>(o.status=e,t&&(h.headers=Object.assign(h.headers,t)),h),h.write=e=>{o.body||(o.body=Buffer.from("")),o.body=Buffer.concat([o.body,Buffer.isBuffer(e)?e:Buffer.from(e)])};let y=t&&(e=>{let t=!1;const r=e["accept-encoding"];if(r)for(let e=0;e<r.length;e++){const{value:n}=r[e];-1!==n.split(",").map((e=>e.split(";")[0].trim())).indexOf("gzip")&&(t=!0)}return t})(s);const m=new Promise((e=>{h.end=t=>{!0!==h.finished&&(h.finished=!0,t&&h.write(t),h.statusCode||(h.statusCode=200),o.body&&(o.bodyEncoding="base64",o.body=y?f.default.gzipSync(o.body).toString("base64"):Buffer.from(o.body).toString("base64")),o.headers=((e,t)=>{const r={},n={};return Object.entries(t).forEach((([e,t])=>{n[e.toLowerCase()]=t})),Object.keys(e).forEach((t=>{const o=t.toLowerCase(),i=e[t];c[o]?n[o]&&(r[o]=n[o]):(r[o]=[],i instanceof Array?i.forEach((e=>{r[o].push({key:t,value:e.toString()})})):r[o].push({key:t,value:i.toString()}))})),r})(h.headers,n.headers),y&&(o.headers["content-encoding"]=[{key:"Content-Encoding",value:"gzip"}]),e(o))}}));return h.setHeader=(e,t)=>{h.headers[e.toLowerCase()]=t},h.removeHeader=e=>{delete h.headers[e.toLowerCase()]},h.getHeader=e=>h.headers[e.toLowerCase()],h.getHeaders=()=>h.headers,h.hasHeader=e=>!!h.getHeader(e),{req:a,res:h,responsePromise:m}};h.SPECIAL_NODE_HEADERS=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];var y=h;function m(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var o=1,i="";if("?"===e[s=r+1])throw new TypeError('Pattern cannot start with "?" at '+s);for(;s<e.length;)if("\\"!==e[s]){if(")"===e[s]){if(0==--o){s++;break}}else if("("===e[s]&&(o++,"?"!==e[s+1]))throw new TypeError("Capturing groups are not allowed at "+s);i+=e[s++]}else i+=e[s++]+e[s++];if(o)throw new TypeError("Unbalanced pattern at "+r);if(!i)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:i}),r=s}else{for(var a="",s=r+1;s<e.length;){var u=e.charCodeAt(s);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;a+=e[s++]}if(!a)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:a}),r=s}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),n=t.prefixes,o=void 0===n?"./":n,i="[^"+E(t.delimiter||"/#?")+"]+?",a=[],s=0,u=0,f="",d=function(e){if(u<r.length&&r[u].type===e)return r[u++].value},c=function(e){var t=d(e);if(void 0!==t)return t;var n=r[u],o=n.type,i=n.index;throw new TypeError("Unexpected "+o+" at "+i+", expected "+e)},l=function(){for(var e,t="";e=d("CHAR")||d("ESCAPED_CHAR");)t+=e;return t};u<r.length;){var p=d("CHAR"),h=d("NAME"),y=d("PATTERN");if(h||y){var m=p||"";-1===o.indexOf(m)&&(f+=m,m=""),f&&(a.push(f),f=""),a.push({name:h||s++,prefix:m,suffix:"",pattern:y||i,modifier:d("MODIFIER")||""})}else{var v=p||d("ESCAPED_CHAR");if(v)f+=v;else if(f&&(a.push(f),f=""),d("OPEN")){m=l();var g=d("NAME")||"",w=d("PATTERN")||"",x=l();c("CLOSE"),a.push({name:g||(w?s++:""),pattern:g&&!w?i:w,prefix:m,suffix:x,modifier:d("MODIFIER")||""})}else c("END")}}return a}function v(e,t){return function(e,t){void 0===t&&(t={});var r=w(t),n=t.encode,o=void 0===n?function(e){return e}:n,i=t.validate,a=void 0===i||i,s=e.map((function(e){if("object"==typeof e)return new RegExp("^(?:"+e.pattern+")$",r)}));return function(t){for(var r="",n=0;n<e.length;n++){var i=e[n];if("string"!=typeof i){var u=t?t[i.name]:void 0,f="?"===i.modifier||"*"===i.modifier,d="*"===i.modifier||"+"===i.modifier;if(Array.isArray(u)){if(!d)throw new TypeError('Expected "'+i.name+'" to not repeat, but got an array');if(0===u.length){if(f)continue;throw new TypeError('Expected "'+i.name+'" to not be empty')}for(var c=0;c<u.length;c++){var l=o(u[c],i);if(a&&!s[n].test(l))throw new TypeError('Expected all "'+i.name+'" to match "'+i.pattern+'", but got "'+l+'"');r+=i.prefix+l+i.suffix}}else if("string"!=typeof u&&"number"!=typeof u){if(!f){var p=d?"an array":"a string";throw new TypeError('Expected "'+i.name+'" to be '+p)}}else{l=o(String(u),i);if(a&&!s[n].test(l))throw new TypeError('Expected "'+i.name+'" to match "'+i.pattern+'", but got "'+l+'"');r+=i.prefix+l+i.suffix}}else r+=i}return r}}(m(e,t),t)}function g(e,t){var r=[];return function(e,t,r){void 0===r&&(r={});var n=r.decode,o=void 0===n?function(e){return e}:n;return function(r){var n=e.exec(r);if(!n)return!1;for(var i=n[0],a=n.index,s=Object.create(null),u=function(e){if(void 0===n[e])return"continue";var r=t[e-1];"*"===r.modifier||"+"===r.modifier?s[r.name]=n[e].split(r.prefix+r.suffix).map((function(e){return o(e,r)})):s[r.name]=o(n[e],r)},f=1;f<n.length;f++)u(f);return{path:i,index:a,params:s}}}(b(e,r,t),r,t)}function E(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function w(e){return e&&e.sensitive?"":"i"}function x(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var n=r.strict,o=void 0!==n&&n,i=r.start,a=void 0===i||i,s=r.end,u=void 0===s||s,f=r.encode,d=void 0===f?function(e){return e}:f,c="["+E(r.endsWith||"")+"]|$",l="["+E(r.delimiter||"/#?")+"]",p=a?"^":"",h=0,y=e;h<y.length;h++){var m=y[h];if("string"==typeof m)p+=E(d(m));else{var v=E(d(m.prefix)),g=E(d(m.suffix));if(m.pattern)if(t&&t.push(m),v||g)if("+"===m.modifier||"*"===m.modifier){var x="*"===m.modifier?"?":"";p+="(?:"+v+"((?:"+m.pattern+")(?:"+g+v+"(?:"+m.pattern+"))*)"+g+")"+x}else p+="(?:"+v+"("+m.pattern+")"+g+")"+m.modifier;else p+="("+m.pattern+")"+m.modifier;else p+="(?:"+v+g+")"+m.modifier}}if(u)o||(p+=l+"?"),p+=r.endsWith?"(?="+c+")":"$";else{var b=e[e.length-1],C="string"==typeof b?l.indexOf(b[b.length-1])>-1:void 0===b;o||(p+="(?:"+l+"(?="+c+"))?"),C||(p+="(?="+l+"|"+c+")")}return new RegExp(p,w(r))}(m(e,r),t,r)}function b(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;var r=e.source.match(/\((?!\?)/g);if(r)for(var n=0;n<r.length;n++)t.push({name:n,prefix:"",suffix:"",modifier:"",pattern:""});return e}(e,t):Array.isArray(e)?function(e,t,r){var n=e.map((function(e){return b(e,t,r).source}));return new RegExp("(?:"+n.join("|")+")",w(r))}(e,t,r):x(e,t,r)}function C(e,t){return g(t,{decode:decodeURIComponent})(e)}function R(e,t){try{const r=e.toLowerCase();if(r.startsWith("https://")||r.startsWith("http://")){const{origin:r,pathname:n}=new URL(e),o=`${r}${v(n,{encode:encodeURIComponent})(t)}`;return!e.endsWith("/")&&o.endsWith("/")?o.slice(0,-1):o}{const r=e.replace(/\?/g,"\\?");return v(r,{encode:encodeURIComponent})(t)}}catch(t){return console.error(`Could not compile destination ${e}, returning null instead. Error: ${t}`),null}}function T(e,t,r){const n=t?`${e}?${t}`:e,i=r.toString();return{status:i,statusDescription:o.STATUS_CODES[i],headers:{location:[{key:"Location",value:n}],refresh:308===r?[{key:"Refresh",value:"0;url="+n}]:[]}}}const P=s.default.basePath,A=e=>(e.startsWith(P)&&(e=e.slice(P.length)),e);exports.handler=async e=>{const t=e.Records[0].cf.request,r=s.default,n=a.default,o=function(e,t){const r=e.headers.host;if(r&&r.length>0){const n=r[0].value,o=t.domainRedirects;if(o&&o[n])return`${o[n]}${e.uri}`}return null}(t,n);if(o)return T(o,t.querystring,308);const i=function(e,t){const r=t.redirects;for(const t of r){const r=C(e,t.source);if(r){const e=R(t.destination,r.params);return e?{redirectPath:e,statusCode:t.statusCode}:null}}return null}(t.uri,r);if(i)return T(i.redirectPath,t.querystring,i.statusCode);if(!n.apis.nonDynamic[A(t.uri)]){const e=function(e,t){const r=t.rewrites;for(const t of r){const r=C(e,t.source);if(r)return R(t.destination,r.params)}return null}(t.uri,r);e&&(t.uri=e)}const u=A(t.uri),f=(e=>{const{apis:{dynamic:t,nonDynamic:r}}=e;return e=>{if(P&&e.startsWith(P)&&(e=e.slice(P.length)),r[e])return r[e];for(const r in t){const{file:n,regex:o}=t[r];if(new RegExp(o,"i").test(e))return n}return null}})(a.default)(u);if(!f)return{status:"404"};const d=require("./"+f),{req:c,res:l,responsePromise:p}=y(e.Records[0].cf,{enableHTTPCompression:n.enableHTTPCompression});d.default(c,l);const h=await p;return function(e,t,r){if(t.headers)for(const n of r.headers)if(C(e,n.source))for(const e of n.headers)if(e.key&&e.value){const r=e.key.toLowerCase();t.headers[r]=[{key:r,value:e.value}]}}(t.uri,h,r),h};
